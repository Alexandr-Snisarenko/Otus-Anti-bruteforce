@startuml CheckAttemptSeq
skinparam DefaultFontName Monospace
actor Client
participant Transport as TR
participant "ApplicationService" as APP
participant "CidrMatcher" as CIDR
participant "RateLimiter" as RL
participant "BucketStore (Redis)" as BS
participant "ListStore (Postgres)" as LS

Client -> TR: CheckAttempt(login, password, ip)
TR -> APP: CheckAttempt(...)
APP -> CIDR: Check(ip)
CIDR -> LS: (on cache miss) load lists
CIDR --> APP: result (WHITE/BLACK/NONE)
alt IP in WHITELIST
  APP --> TR: ok=true (skip limiter)
else IP in BLACKLIST
  APP --> TR: ok=false
else normal flow
  APP -> RL: Allow(login, password, ip)
  RL -> BS: AddAndCount(keys=[login, password, ip])
  BS --> RL: counts
  RL --> APP: decision by limits (N/M/K)
  APP --> TR: ok=decision
end
TR --> Client: result (ok=true/false)
@enduml